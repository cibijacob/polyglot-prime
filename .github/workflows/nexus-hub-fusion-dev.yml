name: Nexus Hub Fusion Polyglot Prime Deployment

on:
  push:
    tags:
      - '*-fusion'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  nexus-hub-fusion-devl-deployment:
    runs-on: ubuntu-latest 
    steps:
      # Checkout the fusion branch into fusion-branch directory
      - name: Checkout fusion branch
        uses: actions/checkout@v4
        with:
          ref: fusion
          path: fusion-branch

      # Checkout the tag that triggered the workflow into tag-code directory
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          path: tag-code

      # Configure git for later usage
      - name: Configure Git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      # Clone infrastructure repository
      - name: Clone infrastructure repository
        run: |
          git clone https://${{ secrets.ACTIONS_GITHUB_TOKEN }}@github.com/tech-by-design/infrastructure-prime.git
           
      # Update fhir environment file with the tag name
      - name: Update fhir environment file
        run: |
          cd infrastructure-prime
          sed -i 's/TAG=.*/TAG=${{ github.ref_name }}/g' aws/hub.dev.fusion.techbd.org/.env

      # Commit and push changes
      - name: Commit and push changes
        run: |
          cd infrastructure-prime
          git add .
          git commit -m "ci: nexus-hub-ui-fusion devl ${{ github.ref_name }} deployment"
          git push
